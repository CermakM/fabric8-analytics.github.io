<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fabric8-Analytics core Jobs service: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Fabric8-Analytics core Jobs service
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Fabric8-Analytics core Jobs service Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://ci.centos.org/job/devtools-fabric8-analytics-jobs-f8a-build-master/"></a></p>
<h1>Fabric8-Analytics core Jobs service</h1>
<p>The aim of this service is to provide a single configuration point for Fabric8-Analytics core periodic tasks or more sophisticated analyses execution (jobs).</p>
<h2>Contributing</h2>
<p>See our https://github.com/fabric8-analytics/common/blob/master/CONTRIBUTING.md "contributing guidelines" for more info.</p>
<h2>Job</h2>
<p>A job is an abstraction in Fabric8-Analytics core that allows one to manipulate with core workers with more granted semantics. An example of a job can be scheduling all analyses that failed, scheduling analyses of new releases, etc.</p>
<p>A job can be run periodically (periodic jobs) or once in the given time (one-shot jobs). All parameters that can be supplied to a job:</p>
<ul>
<li><code>job_id</code> - a unique string (job identifier) to reference and manipulate with the given job, there is generated a job id if it was omitted on job creation</li>
<li><code>periodically</code> - a string that defines whether the job should be run periodically (if omitted the job is run only once (based on <code>when</code>, see bellow); examples:<ul>
<li>"1 week" - run job once a week</li>
<li>"5:00:00" - run job once in 5 hours</li>
</ul>
</li>
<li><code>when</code> - a starting datetime when should be job executed for the first time, if omitted job is scheduled for the current time <em>ALL TIMES ARE IN UTC!</em><ul>
<li>Mon Feb 20, 14:56</li>
</ul>
</li>
<li><code>misfire_grace_time</code> - time that describes allowed delay of jobâ€™s execution before the job is thrown away (for more info see bellow)</li>
<li><code>state</code> - job state<ul>
<li>paused - the job execution is paused/postponed</li>
<li>running - job is active and ready for execution</li>
<li>pending - job is being scheduled</li>
</ul>
</li>
<li><code>kwargs</code> - keyword arguments as supplied to job handler (see Implementing a job section).</li>
</ul>
<h3>Misfire grace time</h3>
<p>Fabric8-Analytics job service can go down. As jobs are stored in the database (PostgreSQL), jobs are not lost. However some jobs could be possibly executed during the service unavailability. Misfire grace time is taken in account when the job service goes up again - if there would be some jobs scheduled during the service unavailability, misfire grace time tells scheduler whether these jobs should be run - if scheduled time plus misfire grace time is less then the current time.</p>
<h2>Default jobs</h2>
<p>Default jobs can be found in <code>f8a_jobs/default_jobs/</code> directory. These jobs are described in a YAML file (one file per job definition). The configuration keys stated in YAML files conform to job options as described above. Required are <code>job_id</code> (to avoid job duplication since these jobs are added each time on start up), <code>kwargs</code> and <code>handler</code>. If some configuration options are not stated, they default to values as in section above. Browse <code>f8a_jobs/default_jobs/</code> directory for examples.</p>
<h2>Adding a new job</h2>
<p>A new job can be added by:</p>
<ul>
<li>doing request to API - once the database will be erased, these jobs will disappear</li>
<li>specifying job in a YAML file - these jobs are inserted to database on each start up (duplicities are avoided)</li>
</ul>
<h3>Running a custom job</h3>
<p>You can use UI that will automatically create periodic jobs, do POST requests for you or generate curl commands that can be run. Just go to the <code>/api/v1/ui/</code> endpoint and:</p>
<ol type="1">
<li>click on "Add new jobs"</li>
<li>Select desired action, for analyses scheduling click on "POST /jobs/flow-scheduling"</li>
<li>Modify job parameters if needed<ul>
<li>! Make sure you create a job with a state you want - <code>running</code> or <code>paused</code></li>
</ul>
</li>
<li>Follow example arguments - you can click on the example on the right hand side and modify it as desired</li>
<li>Click on "Try it out!", the flow will be scheduled</li>
</ol>
<p>The UI will also prepare a curl command for you. Here is an example for analyses scheduling for two packages (localhost):</p>
<div class="fragment"><div class="line">curl -X POST --header &#39;Content-Type: application/json&#39; --header &#39;Accept: application/json&#39; -d &#39;{ </div><div class="line">   &quot;flow_arguments&quot;: [ </div><div class="line">     { </div><div class="line">       &quot;ecosystem&quot;: &quot;npm&quot;, </div><div class="line">       &quot;force&quot;: true, </div><div class="line">       &quot;name&quot;: &quot;serve-static&quot;, </div><div class="line">       &quot;version&quot;: &quot;1.7.1&quot; </div><div class="line">     }, </div><div class="line">     { </div><div class="line">       &quot;ecosystem&quot;: &quot;maven&quot;, </div><div class="line">       &quot;force&quot;: true, </div><div class="line">       &quot;name&quot;: &quot;net.iharder:base64&quot;, </div><div class="line">       &quot;version&quot;: &quot;2.3.9&quot; </div><div class="line">     } </div><div class="line">   ], </div><div class="line">   &quot;flow_name&quot;: &quot;bayesianFlow&quot; </div><div class="line"> }&#39; &#39;http://localhost:34000/api/v1/jobs/flow-scheduling?state=running&#39;</div></div><!-- fragment --><p>If something went wrong, check failed jobs in "Jobs options", <code>/jobs</code> endpoint. There are tracked failed jobs with all the details such as exceptions that were raised, see bellow.</p>
<h2>Job failures</h2>
<p>If a job fails, there is inserted a log entry to database. This entry is basically an empty job (when run it does nothing) with information that describe failure (traceback) and job arguments.</p>
<h2>Implementing a job</h2>
<p>In order to implement a job, follow these steps:</p>
<ol type="1">
<li>Add your job handler to <code>f8a_jobs/handlers/</code> module. This handler has to be a class that derives from <code>f8a_jobs.handlers.BaseHandler</code>. Implement <code>execute()</code> method and give it arguments you would like to get from API calls or YAML configuration file.</li>
<li>Introduce API endpoint and handler-specific POST entry to <code>f8a_jobs/swagger.yaml</code> with an example of <code>kwargs</code>. Check already existing entries as an example.</li>
<li>Add function (<code>operationId</code>) to <code>f8a_jobs/api_v1.py</code> that will translate API call to <code>post_schedule_job</code>. See examples for more info (see section <code>Handler specific POST requests</code> in the source code).</li>
<li>Use your job handler.</li>
</ol>
<p>Note: Do not try to automatize/remove step 3. It is not possible to do something like <code>partial</code> or <code>__call__</code> to class as Connexion is checking file existence. Function for each API endpoint has to be unique and it <em>really has to be</em> a function.</p>
<h1>Prepared queries that might be useful</h1>
<p>The list bellow states examples of filter queries not specific to any flow. An example of usage could be an HTTP POST request to <code>/api/v1/jobs/flow-scheduling</code> for flow scheduling with appropriate parameters (see the <code>curl</code> example above):</p>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;flow_arguments&quot;: [</div><div class="line">    { </div><div class="line">      &quot;$filter&quot;: &quot;YOUR-FILTER-QUERY-GOES-HERE&quot;</div><div class="line">    }</div><div class="line">  ],</div><div class="line">  &quot;flow_name&quot;: &quot;bayesianFlow&quot;</div><div class="line">}</div></div><!-- fragment --><p>If you wish to schedule only certain tasks in flows, feel free to post your HTTP POST request to <code>/api/v1/jobs/flow-scheduling</code> endpoint: ```json { "flow_arguments": [ { "$filter": "YOUR-FILTER-QUERY-GOES-HERE" } ], "flow_name": "bayesianFlow", "run_subsequent": false, "task_names": [ "github_details", "ResultCollector" ] } ````</p>
<h2>Run graph syncs of previously analysed Ecosystem-Package-Version</h2>
<p>Note this represents the whole job arguments in which there are only first 1000 packages synced, post this to <code>/api/v1/jobs/selective-flow-scheduling</code> endpoint.</p>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;flow_arguments&quot;: [</div><div class="line">    {</div><div class="line">      &quot;force&quot;: true,</div><div class="line">      &quot;$filter&quot;: {</div><div class="line">        &quot;joins&quot;: [</div><div class="line">          {</div><div class="line">            &quot;on&quot;: {</div><div class="line">              &quot;analyses.id&quot;: &quot;versions.id&quot;</div><div class="line">            },</div><div class="line">            &quot;table&quot;: &quot;versions&quot;</div><div class="line">          },</div><div class="line">          {</div><div class="line">            &quot;on&quot;: {</div><div class="line">              &quot;versions.package_id&quot;: &quot;packages.id&quot;</div><div class="line">            },</div><div class="line">            &quot;table&quot;: &quot;packages&quot;</div><div class="line">          },</div><div class="line">          {</div><div class="line">            &quot;on&quot;: {</div><div class="line">              &quot;ecosystems.id&quot;: &quot;packages.ecosystem_id&quot;</div><div class="line">            },</div><div class="line">            &quot;table&quot;: &quot;ecosystems&quot;</div><div class="line">          }</div><div class="line">        ],</div><div class="line">        &quot;limit&quot;: 1000,</div><div class="line">        &quot;table&quot;: &quot;analyses&quot;,</div><div class="line">        &quot;order_by&quot;: &quot;analyses.id desc&quot;,</div><div class="line">        &quot;select&quot;: [</div><div class="line">          &quot;versions.identifier as version&quot;,</div><div class="line">          &quot;packages.name as name&quot;,</div><div class="line">          &quot;ecosystems.name as ecosystem&quot;</div><div class="line">        ],</div><div class="line">        &quot;where&quot;: {</div><div class="line">          &quot;analyses.id in&quot;: {</div><div class="line">            &quot;$filter&quot;: {</div><div class="line">              &quot;joins&quot;: [</div><div class="line">                {</div><div class="line">                  &quot;on&quot;: {</div><div class="line">                    &quot;worker_results.analysis_id&quot;: &quot;analyses.id&quot;</div><div class="line">                  },</div><div class="line">                  &quot;table&quot;: &quot;analyses&quot;</div><div class="line">                },</div><div class="line">                {</div><div class="line">                  &quot;on&quot;: {</div><div class="line">                    &quot;analyses.id&quot;: &quot;versions.id&quot;</div><div class="line">                  },</div><div class="line">                  &quot;table&quot;: &quot;versions&quot;</div><div class="line">                },</div><div class="line">                {</div><div class="line">                  &quot;on&quot;: {</div><div class="line">                    &quot;versions.package_id&quot;: &quot;packages.id&quot;</div><div class="line">                  },</div><div class="line">                  &quot;table&quot;: &quot;packages&quot;</div><div class="line">                },</div><div class="line">                {</div><div class="line">                  &quot;on&quot;: {</div><div class="line">                    &quot;ecosystems.id&quot;: &quot;packages.ecosystem_id&quot;</div><div class="line">                  },</div><div class="line">                  &quot;table&quot;: &quot;ecosystems&quot;</div><div class="line">                }</div><div class="line">              ],</div><div class="line">              &quot;table&quot;: &quot;worker_results&quot;,</div><div class="line">              &quot;select&quot;: [</div><div class="line">                &quot;analyses.id as analyses_id&quot;</div><div class="line">              ],</div><div class="line">              &quot;distinct&quot;: true,</div><div class="line">              &quot;where&quot;: {</div><div class="line">                &quot;analyses.finished_at is not&quot;: null</div><div class="line">              }</div><div class="line">            }</div><div class="line">          }</div><div class="line">        }</div><div class="line">      }</div><div class="line">    }</div><div class="line">  ],</div><div class="line">  &quot;flow_name&quot;: &quot;bayesianFlow&quot;,</div><div class="line">  &quot;run_subsequent&quot;: false,</div><div class="line">  &quot;task_names&quot;: [</div><div class="line">    &quot;GraphImporterTask&quot;</div><div class="line">  ]</div><div class="line">}</div></div><!-- fragment --><h2>Force run all analyses which failed</h2>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;$filter&quot;: {</div><div class="line">    &quot;joins&quot;: [</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;worker_results.analysis_id&quot;: &quot;analyses.id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;analyses&quot;</div><div class="line">      },</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;analyses.id&quot;: &quot;versions.id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;versions&quot;</div><div class="line">      },</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;versions.package_id&quot;: &quot;packages.id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;packages&quot;</div><div class="line">      },</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;ecosystems.id&quot;: &quot;packages.ecosystem_id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;ecosystems&quot;</div><div class="line">      }</div><div class="line">    ],</div><div class="line">    &quot;select&quot;: [</div><div class="line">      &quot;packages.name as name&quot;,</div><div class="line">      &quot;ecosystems.name as ecosystem&quot;,</div><div class="line">      &quot;versions.identifier as version&quot;</div><div class="line">    ],</div><div class="line">    &quot;table&quot;: &quot;worker_results&quot;,</div><div class="line">    &quot;where&quot;: {</div><div class="line">      &quot;worker_results.error&quot;: true</div><div class="line">    }</div><div class="line">  },</div><div class="line">  &quot;force&quot;: true</div><div class="line">}</div></div><!-- fragment --><h2>Force analyses that started at some date</h2>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;$filter&quot;: {</div><div class="line">    &quot;joins&quot;: [</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;analyses.id&quot;: &quot;versions.id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;versions&quot;</div><div class="line">      },</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;versions.package_id&quot;: &quot;packages.id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;packages&quot;</div><div class="line">      },</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;ecosystems.id&quot;: &quot;packages.ecosystem_id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;ecosystems&quot;</div><div class="line">      }</div><div class="line">    ],</div><div class="line">    &quot;select&quot;: [</div><div class="line">      &quot;packages.name as name&quot;,</div><div class="line">      &quot;ecosystems.name as ecosystem&quot;,</div><div class="line">      &quot;versions.identifier as version&quot;</div><div class="line">    ],</div><div class="line">    &quot;table&quot;: &quot;analyses&quot;,</div><div class="line">    &quot;where&quot;: {</div><div class="line">      &quot;analyses.started_at &gt;&quot;: &quot;2017-04-01 20:00:00&quot;</div><div class="line">    }</div><div class="line">  },</div><div class="line">  &quot;force&quot;: true</div><div class="line">}</div></div><!-- fragment --><h2>Force analyses which did not finish:</h2>
<p>Note that this schedules analyses that are in progress.</p>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;$filter&quot;: {</div><div class="line">    &quot;joins&quot;: [</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;analyses.id&quot;: &quot;versions.id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;versions&quot;</div><div class="line">      },</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;versions.package_id&quot;: &quot;packages.id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;packages&quot;</div><div class="line">      },</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;ecosystems.id&quot;: &quot;packages.ecosystem_id&quot;</div><div class="line">        },</div><div class="line">        &quot;table&quot;: &quot;ecosystems&quot;</div><div class="line">      }</div><div class="line">    ],</div><div class="line">    &quot;select&quot;: [</div><div class="line">      &quot;packages.name as name&quot;,</div><div class="line">      &quot;ecosystems.name as ecosystem&quot;,</div><div class="line">      &quot;versions.identifier as version&quot;</div><div class="line">    ],</div><div class="line">    &quot;table&quot;: &quot;analyses&quot;,</div><div class="line">    &quot;where&quot;: {</div><div class="line">      &quot;analyses.finished_at&quot;: null</div><div class="line">    }</div><div class="line">  },</div><div class="line">  &quot;force&quot;: true</div><div class="line">}</div></div><!-- fragment --><h2>Number of analyses in database</h2>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;$filter&quot;: {</div><div class="line">    &quot;table&quot;: &quot;analyses&quot;,</div><div class="line">    &quot;count&quot;: true</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><h2>Schedule all analyses that have <code>finished_at</code> NULL and there is no newer successful analysis for the given EPV</h2>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;force&quot;: true,</div><div class="line">  &quot;$filter&quot;: {</div><div class="line">    &quot;joins&quot;: [</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;A.version_id&quot;: &quot;versions.id&quot;</div><div class="line">        },</div><div class="line">        &quot;type&quot;: &quot;left&quot;,</div><div class="line">        &quot;table&quot;: &quot;versions&quot;</div><div class="line">      },</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;versions.package_id&quot;: &quot;packages.id&quot;</div><div class="line">        },</div><div class="line">        &quot;type&quot;: &quot;left&quot;,</div><div class="line">        &quot;table&quot;: &quot;packages&quot;</div><div class="line">      },</div><div class="line">      {</div><div class="line">        &quot;on&quot;: {</div><div class="line">          &quot;packages.ecosystem_id&quot;: &quot;ecosystems.id&quot;</div><div class="line">        },</div><div class="line">        &quot;type&quot;: &quot;left&quot;,</div><div class="line">        &quot;table&quot;: &quot;ecosystems&quot;</div><div class="line">      }</div><div class="line">    ],</div><div class="line">    &quot;select&quot;: [</div><div class="line">      &quot;versions.identifier as version&quot;,</div><div class="line">      &quot;packages.name as name&quot;,</div><div class="line">      &quot;ecosystems.name as ecosystem&quot;,</div><div class="line">    ],</div><div class="line">    &quot;table&quot;: &quot;analyses AS A&quot;,</div><div class="line">    &quot;distinct&quot;: true,</div><div class="line">    &quot;where&quot;: {</div><div class="line">      &quot;A.finished_at is&quot;: null,</div><div class="line">      &quot;versions.id not in&quot;: {</div><div class="line">        &quot;$filter&quot;: {</div><div class="line">          &quot;joins&quot;: [</div><div class="line">            {</div><div class="line">              &quot;on&quot;: {</div><div class="line">                &quot;analyses.version_id&quot;: &quot;versions.id&quot;</div><div class="line">              },</div><div class="line">              &quot;type&quot;: &quot;left&quot;,</div><div class="line">              &quot;table&quot;: &quot;versions&quot;</div><div class="line">            }</div><div class="line">          ],</div><div class="line">          &quot;table&quot;: &quot;analyses&quot;,</div><div class="line">          &quot;select&quot;: &quot;versions.id&quot;,</div><div class="line">          &quot;where&quot;: {&quot;analyses.finished_at is not&quot;: null, &quot;analyses.started_at &gt;&quot;: &quot;$A.started_at&quot;}</div><div class="line">        }</div><div class="line">      }</div><div class="line">    }</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><p>Translated into: </p><div class="fragment"><div class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> <span class="stringliteral">&quot;versions&quot;</span>.<span class="stringliteral">&quot;identifier&quot;</span> <span class="keyword">AS</span> <span class="stringliteral">&quot;version&quot;</span>, <span class="stringliteral">&quot;packages&quot;</span>.<span class="stringliteral">&quot;name&quot;</span> <span class="keyword">AS</span> <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;ecosystems&quot;</span>.<span class="stringliteral">&quot;name&quot;</span> <span class="keyword">AS</span> <span class="stringliteral">&quot;ecosystem&quot;</span>, <span class="stringliteral">&quot;versions&quot;</span>.<span class="stringliteral">&quot;id&quot;</span> <span class="keyword">AS</span> <span class="stringliteral">&quot;version_id&quot;</span> <span class="keyword">FROM</span> <span class="stringliteral">&quot;analyses&quot;</span> <span class="keyword">AS</span> <span class="stringliteral">&quot;A&quot;</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="stringliteral">&quot;versions&quot;</span> <span class="keyword">ON</span> <span class="stringliteral">&quot;A&quot;</span>.<span class="stringliteral">&quot;version_id&quot;</span> = <span class="stringliteral">&quot;versions&quot;</span>.<span class="stringliteral">&quot;id&quot;</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="stringliteral">&quot;packages&quot;</span> <span class="keyword">ON</span> <span class="stringliteral">&quot;versions&quot;</span>.<span class="stringliteral">&quot;package_id&quot;</span> = <span class="stringliteral">&quot;packages&quot;</span>.<span class="stringliteral">&quot;id&quot;</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="stringliteral">&quot;ecosystems&quot;</span> <span class="keyword">ON</span> <span class="stringliteral">&quot;packages&quot;</span>.<span class="stringliteral">&quot;ecosystem_id&quot;</span> = <span class="stringliteral">&quot;ecosystems&quot;</span>.<span class="stringliteral">&quot;id&quot;</span> <span class="keyword">WHERE</span> <span class="stringliteral">&quot;versions&quot;</span>.<span class="stringliteral">&quot;id&quot;</span> <span class="keyword">NOT</span> <span class="keyword">IN</span> ( <span class="keyword">SELECT</span> <span class="stringliteral">&quot;versions&quot;</span>.<span class="stringliteral">&quot;id&quot;</span> <span class="keyword">FROM</span> <span class="stringliteral">&quot;analyses&quot;</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="stringliteral">&quot;versions&quot;</span> <span class="keyword">ON</span> <span class="stringliteral">&quot;analyses&quot;</span>.<span class="stringliteral">&quot;version_id&quot;</span> = <span class="stringliteral">&quot;versions&quot;</span>.<span class="stringliteral">&quot;id&quot;</span> <span class="keyword">WHERE</span> <span class="stringliteral">&quot;analyses&quot;</span>.<span class="stringliteral">&quot;finished_at&quot;</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="stringliteral">NULL</span> <span class="keyword">AND</span> <span class="stringliteral">&quot;analyses&quot;</span>.<span class="stringliteral">&quot;started_at&quot;</span> &gt; <span class="stringliteral">&quot;A&quot;</span>.<span class="stringliteral">&quot;started_at&quot;</span> ) <span class="keyword">AND</span> <span class="stringliteral">&quot;A&quot;</span>.<span class="stringliteral">&quot;finished_at&quot;</span> <span class="keyword">IS</span> <span class="stringliteral">NULL</span></div></div><!-- fragment --><h2>Notes to filter queries</h2>
<p>All queries listed above select ecosystem/package/version triplet as most flows expect these to be present as flow arguments. Feel free to modify the select statement if necessary.</p>
<p>Nested queries are supported. Just state nested "$filter".</p>
<p>If you wish to try your query, feel free to POST your query to <code>/api/v1/debug-expand-filter</code> to see what results you get with your query or <code>/api/v1/debug-show-select-query</code> to see how the JSON is translated into an SQL expression.</p>
<p>If you need any help, contact Fridolin. Also if you find some query useful, feel free to open a PR.</p>
<h1>Authentication &amp; Authorization</h1>
<p>If the jobs service is running in production environment, there needs to be done authentication in order to manipulate with endpoints. Jobs service authenticates users against Github OAuth which provides you a token that you can use to do post requests.</p>
<p>You can generate token by accessing <code>/api/v1/generate-token</code> endpoint. It will redirect you to Github, which will ask for access to your account info in order to verify that you are a member of Github organization. Once you grant the access, you will be redirected back to Jobs service, which gives you information about your current token.</p>
<p>Note that if you are using Swagger UI, you cannot use this UI for generating endpoints as Swagger does not follow redirects.</p>
<p>Once you are authorized, use your token to access application endpoints - it is expected to state token in <code>AUTH-TOKEN</code> header. If you are using Swagger UI, press the <code>Authorize</code> button in the header bar and place your token there. After that Swagger UI will transparently use your token for authorization. Note that Swagger UI is client-side application - it constructs requests in your browser so you have to do these steps manually.</p>
<p>If you want to logout, just access <code>/api/v1/logout</code> endpoint, which will remove active token from the current session.</p>
<p>To get info about the current session, access <code>/api/v1/authorized</code> endpoint.</p>
<p>If you cannot authenticate, please make sure you are a member of fabric8-analytics organization on GitHub. If you are still getting authentication errors, try to <a href="https://help.github.com/articles/publicizing-or-hiding-organization-membership/">switch from private organization member to public organization member</a>.</p>
<h1>Collecting and processing manifest files from GitHub</h1>
<p>There are two jobs that can be used to collect and process manifest files from GitHub. The first one is called <code>jobs/github-manifests</code>. This job collects and processes manifest files from given GitHub repositories. Example usage:</p>
<div class="fragment"><div class="line">curl -X POST --header &#39;Content-Type: application/json&#39; --header &#39;Accept: application/json&#39; --header &#39;auth-token: &lt;your-token-here&gt;&#39; -d &#39;{</div><div class="line">   &quot;repositories&quot;: [</div><div class="line">     {</div><div class="line">       &quot;ecosystem&quot;: &quot;maven&quot;,</div><div class="line">       &quot;force&quot;: true,</div><div class="line">       &quot;force_graph_sync&quot;: false,</div><div class="line">       &quot;recursive_limit&quot;: 0,</div><div class="line">       &quot;repo_name&quot;: &quot;omalley/base64&quot;</div><div class="line">     }</div><div class="line">   ]</div><div class="line"> }&#39; &#39;http://bayesian-jobs-bayesian-production.09b5.dsaas.openshiftapps.com/api/v1/jobs/github-manifests?state=running&amp;skip_if_exists=true&#39;</div></div><!-- fragment --><p>The command above will collect manifest files from <a href="https://github.com/omalley/base64">https://github.com/omalley/base64</a> and analyze dependencies found in those manifest files.</p>
<p>It's possible to later aggregate package names from already analyzed manifest files. It can be achieved with a job called <code>jobs/aggregate-github-manifest-pkgs</code>. Example usage:</p>
<div class="fragment"><div class="line">curl -X POST --header &#39;Content-Type: application/json&#39; --header &#39;Accept: application/json&#39; --header &#39;auth-token: &lt;your-token-here&gt;&#39; -d &#39;{</div><div class="line">   &quot;repositories&quot;: [</div><div class="line">     {</div><div class="line">       &quot;ecosystem&quot;: &quot;maven&quot;,</div><div class="line">       &quot;repo_name&quot;: &quot;omalley/base64&quot;</div><div class="line">     }</div><div class="line">   ]</div><div class="line"> }&#39; &#39;http://bayesian-jobs-bayesian-production.09b5.dsaas.openshiftapps.com/api/v1/jobs/aggregate-github-manifest-pkgs?state=running&amp;bucket_name=my-bucket&amp;object_key=packages_list.json&amp;ecosystem=maven&#39;</div></div><!-- fragment --><p>The command above will aggregate package names from manifest files found in given repositories and store them in <code>packages_list.json</code> object in <code>my-bucket</code> S3 bucket.</p>
<p>Note both jobs require <a href="#authentication-authorization">authentication</a>.</p>
<h2>See Also</h2>
<p><a href="https://github.com/zalando/connexion">Connexion</a> - framework used for YAML configuration of API endpoints for Flask <a href="http://apscheduler.readthedocs.io/en/latest/">apscheduler</a> - Advanced Python Scheduler used for scheduling jobs (and job's persistence)</p>
<h3>Footnotes</h3>
<h4>Coding standards</h4>
<ul>
<li>You can use scripts <code>run-linter.sh</code> and <code>check-docstyle.sh</code> to check if the code follows <a href="https://www.python.org/dev/peps/pep-0008/">PEP 8</a> and <a href="https://www.python.org/dev/peps/pep-0257/">PEP 257</a> coding standards. These scripts can be run w/o any arguments:</li>
</ul>
<div class="fragment"><div class="line">./run-linter.sh</div><div class="line">./check-docstyle.sh</div></div><!-- fragment --><p>The first script checks the indentation, line lengths, variable names, white space around operators etc. The second script checks all documentation strings - its presence and format. Please fix any warnings and errors reported by these scripts.</p>
<h4>Code complexity measurement</h4>
<p>The scripts <code>measure-cyclomatic-complexity.sh</code> and <code>measure-maintainability-index.sh</code> are used to measure code complexity. These scripts can be run w/o any arguments:</p>
<div class="fragment"><div class="line">./measure-cyclomatic-complexity.sh</div><div class="line">./measure-maintainability-index.sh</div></div><!-- fragment --><p>The first script measures cyclomatic complexity of all Python sources found in the repository. Please see <a href="https://radon.readthedocs.io/en/latest/commandline.html#the-cc-command">this table</a> for further explanation how to comprehend the results.</p>
<p>The second script measures maintainability index of all Python sources found in the repository. Please see <a href="https://radon.readthedocs.io/en/latest/commandline.html#the-mi-command">the following link</a> with explanation of this measurement. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
